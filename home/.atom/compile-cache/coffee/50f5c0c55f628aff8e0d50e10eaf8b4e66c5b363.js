(function() {
  var CONFIG_DEFAULTS, CONFIG_KEY_INTERVAL_MINUTES, MINIMUM_AUTO_UPDATE_BLOCK_DURATION_MINUTES, NAMESPACE, PackageUpdater, WARMUP_WAIT, fs, getFs, path;

  fs = null;

  path = null;

  PackageUpdater = null;

  getFs = function() {
    return fs != null ? fs : fs = require('fs-plus');
  };

  NAMESPACE = 'auto-update-packages';

  CONFIG_KEY_INTERVAL_MINUTES = 'intervalMinutes';

  CONFIG_DEFAULTS = {};

  CONFIG_DEFAULTS[CONFIG_KEY_INTERVAL_MINUTES] = 6 * 60;

  WARMUP_WAIT = 10 * 1000;

  MINIMUM_AUTO_UPDATE_BLOCK_DURATION_MINUTES = 15;

  module.exports = {
    configDefaults: CONFIG_DEFAULTS,
    activate: function(state) {
      atom.workspaceView.command("" + NAMESPACE + ":update-now", (function(_this) {
        return function() {
          return _this.updatePackages(false);
        };
      })(this));
      return setTimeout((function(_this) {
        return function() {
          return _this.enableAutoUpdate();
        };
      })(this), WARMUP_WAIT);
    },
    deactivate: function() {
      this.disableAutoUpdate();
      return atom.workspaceView.off("" + NAMESPACE + ":update-now");
    },
    enableAutoUpdate: function() {
      this.updatePackagesIfAutoUpdateBlockIsExpired();
      this.autoUpdateCheck = setInterval((function(_this) {
        return function() {
          return _this.updatePackagesIfAutoUpdateBlockIsExpired();
        };
      })(this), this.getAutoUpdateCheckInterval());
      return this.configSubscription = atom.config.observe(NAMESPACE, {
        callNow: false
      }, (function(_this) {
        return function() {
          _this.disableAutoUpdate();
          return _this.enableAutoUpdate();
        };
      })(this));
    },
    disableAutoUpdate: function() {
      var _ref;
      if ((_ref = this.configSubscription) != null) {
        _ref.off();
      }
      this.configSubscription = null;
      if (this.autoUpdateCheck) {
        clearInterval(this.autoUpdateCheck);
      }
      return this.autoUpdateCheck = null;
    },
    updatePackagesIfAutoUpdateBlockIsExpired: function() {
      var lastUpdateTime;
      lastUpdateTime = this.loadLastUpdateTime() || 0;
      if (Date.now() > lastUpdateTime + this.getAutoUpdateBlockDuration()) {
        return this.updatePackages();
      }
    },
    updatePackages: function(isAutoUpdate) {
      if (isAutoUpdate == null) {
        isAutoUpdate = true;
      }
      if (PackageUpdater == null) {
        PackageUpdater = require('./package-updater');
      }
      PackageUpdater.updatePackages(isAutoUpdate);
      return this.saveLastUpdateTime();
    },
    getAutoUpdateBlockDuration: function() {
      var minutes;
      minutes = atom.config.get([NAMESPACE, CONFIG_KEY_INTERVAL_MINUTES].join('.'));
      if (minutes < MINIMUM_AUTO_UPDATE_BLOCK_DURATION_MINUTES) {
        minutes = MINIMUM_AUTO_UPDATE_BLOCK_DURATION_MINUTES;
      }
      return minutes * 60 * 1000;
    },
    getAutoUpdateCheckInterval: function() {
      return this.getAutoUpdateBlockDuration() / 15;
    },
    loadLastUpdateTime: function() {
      var string;
      try {
        string = getFs().readFileSync(this.getLastUpdateTimeFilePath());
        return parseInt(string);
      } catch (_error) {
        return null;
      }
    },
    saveLastUpdateTime: function() {
      return getFs().writeFileSync(this.getLastUpdateTimeFilePath(), Date.now().toString());
    },
    getLastUpdateTimeFilePath: function() {
      var dotAtomPath;
      if (path == null) {
        path = require('path');
      }
      dotAtomPath = getFs().absolute('~/.atom');
      return path.join(dotAtomPath, 'storage', "" + NAMESPACE + "-last-update-time");
    }
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAiZmlsZSI6ICIiLAogICJzb3VyY2VSb290IjogIiIsCiAgInNvdXJjZXMiOiBbCiAgICAiIgogIF0sCiAgIm5hbWVzIjogW10sCiAgIm1hcHBpbmdzIjogIkFBQUE7QUFBQSxNQUFBLGlKQUFBOztBQUFBLEVBQUEsRUFBQSxHQUFLLElBQUwsQ0FBQTs7QUFBQSxFQUNBLElBQUEsR0FBTyxJQURQLENBQUE7O0FBQUEsRUFFQSxjQUFBLEdBQWlCLElBRmpCLENBQUE7O0FBQUEsRUFJQSxLQUFBLEdBQVEsU0FBQSxHQUFBO3dCQUNOLEtBQUEsS0FBTSxPQUFBLENBQVEsU0FBUixFQURBO0VBQUEsQ0FKUixDQUFBOztBQUFBLEVBT0EsU0FBQSxHQUFZLHNCQVBaLENBQUE7O0FBQUEsRUFRQSwyQkFBQSxHQUE4QixpQkFSOUIsQ0FBQTs7QUFBQSxFQVVBLGVBQUEsR0FBa0IsRUFWbEIsQ0FBQTs7QUFBQSxFQVdBLGVBQWdCLENBQUEsMkJBQUEsQ0FBaEIsR0FBK0MsQ0FBQSxHQUFJLEVBWG5ELENBQUE7O0FBQUEsRUFhQSxXQUFBLEdBQWMsRUFBQSxHQUFLLElBYm5CLENBQUE7O0FBQUEsRUFjQSwwQ0FBQSxHQUE2QyxFQWQ3QyxDQUFBOztBQUFBLEVBZ0JBLE1BQU0sQ0FBQyxPQUFQLEdBQ0U7QUFBQSxJQUFBLGNBQUEsRUFBZ0IsZUFBaEI7QUFBQSxJQUVBLFFBQUEsRUFBVSxTQUFDLEtBQUQsR0FBQTtBQUNSLE1BQUEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFuQixDQUEyQixFQUFBLEdBQUUsU0FBRixHQUFhLGFBQXhDLEVBQXNELENBQUEsU0FBQSxLQUFBLEdBQUE7ZUFBQSxTQUFBLEdBQUE7aUJBQ3BELEtBQUMsQ0FBQSxjQUFELENBQWdCLEtBQWhCLEVBRG9EO1FBQUEsRUFBQTtNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBdEQsQ0FBQSxDQUFBO2FBR0EsVUFBQSxDQUFXLENBQUEsU0FBQSxLQUFBLEdBQUE7ZUFBQSxTQUFBLEdBQUE7aUJBQ1QsS0FBQyxD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
//# sourceURL=/Users/frosas/projects/dotfiles/home/.atom/packages/auto-update-packages/lib/auto-update-packages.coffee