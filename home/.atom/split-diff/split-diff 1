var type = function(o) {
    var actualType = Object.prototype.toString.call(o);
    return actualType.substr(8).replace(']', '');
};

function undefined(obj) {
    return (type(obj) == 'Undefined');
}

var KeyValueTransformer = function(f, k) {
    var fieldSeparator = f;
    var kvSeparator = k;

    function toJson(kvpairs) {
        var json = {};
        kvpairs.split(fieldSeparator).forEach(function(s) {
            var kv = s.split(kvSeparator).map(function(s1) {
                return s1.trim();
            });
            json[kv[0]] = kv[1];
        });
        return json;
    }

    this.handle = function(data) {
        return toJson(data);
    }
};

var kvTransformer = new KeyValueTransformer(';', '=');
var BloomFilter = require('bloomfilter').BloomFilter;
var bloom = new BloomFilter(
    32 * 4096, 16
);

var args = require('minimist')(process.argv);

var in_file = args['file'];
var do_bloom = args['bloom'];
if (undefined(in_file)) {
    throw Error('Please check the value of file');
}

var lineReader = require('readline').createInterface({ input: require('fs').createReadStream(in_file) });

lineReader.on('line', function (line) {
    if (line.trim().length > 0) {
        try {
            var obj = JSON.parse(line);
            var cookie = kvTransformer.handle(decodeURIComponent(obj.reqHdr.cookie));
            var cesc = cookie.cesc;
            if (cesc.trim().length != 0) {
                if (do_bloom) {
                    if (!bloom.test(cesc)) {
                        bloom.add(cesc);
                        console.log(cesc);
                    }
                }
                else {
                    console.log(cesc);
                }
            }
        }
        catch (e) {
            //console.log(e);
        }
    }
});
